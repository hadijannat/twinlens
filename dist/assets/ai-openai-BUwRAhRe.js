var T=Object.defineProperty;var x=(i,e,t)=>e in i?T(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>x(i,typeof e!="symbol"?e+"":e,t);import{g as O,a as E}from"./settings-B4XEWWU_.js";import{f as P,a as u}from"./ai-anthropic-CECBs50x.js";const $=new Set(["host","content-length","transfer-encoding","connection","cookie","set-cookie","origin","authorization","x-api-key","anthropic-version"]);function k(i){if(!i)return{};const e={};for(const[t,s]of Object.entries(i)){const n=t.toLowerCase();if($.has(n)){console.warn(`Blocked header override attempt: ${t}`);continue}if(/[\r\n]/.test(s)){console.warn(`Blocked CRLF injection attempt in header: ${t}`);continue}e[t]=s}return e}class A{constructor(e){d(this,"settings");d(this,"baseUrl");d(this,"model");this.settings=e,this.baseUrl=O(e),this.model=E(e)}async chat(e,t,s){var h;const o=[{role:"system",content:P(t)},...e.map(p=>({role:p.role,content:p.content}))],r={"Content-Type":"application/json"};(h=this.settings.apiKey)!=null&&h.trim()&&(r.Authorization=`Bearer ${this.settings.apiKey.trim()}`);const l=k(this.settings.extraHeaders);Object.assign(r,l),(this.settings.provider==="openrouter"||this.baseUrl.includes("openrouter.ai"))&&(r["HTTP-Referer"]="https://twinlens.app",r["X-Title"]="TwinLens");const a={model:this.model,messages:o,max_tokens:this.settings.maxTokens||1024,temperature:this.settings.temperature??.7,stream:!!s},c=`${this.baseUrl}/chat/completions`;return s?this.streamChat(c,r,a,s):this.nonStreamChat(c,r,a)}async nonStreamChat(e,t,s){var l,a;const n=await u(e,{method:"POST",headers:t,body:JSON.stringify(s)});if(!n.ok){const c=await n.text();throw new Error(`API error ${n.status}: ${c}`)}const o=await n.json();return{content:((a=(l=o.choices[0])==null?void 0:l.message)==null?void 0:a.content)||"",usage:o.usage?{inputTokens:o.usage.prompt_tokens,outputTokens:o.usage.completion_tokens}:void 0}}async streamChat(e,t,s,n){var h,p,g;const o=await u(e,{method:"POST",headers:t,body:JSON.stringify(s)});if(!o.ok){const m=await o.text();throw new Error(`API error ${o.status}: ${m}`)}const r=(h=o.body)==null?void 0:h.getReader();if(!r)throw new Error("No response body");const l=new TextDecoder;let a="",c="";for(;;){const{done:m,value:C}=await r.read();if(m)break;c+=l.decode(C,{stream:!0});const y=c.split(`
`);c=y.pop()||"";for(const w of y)if(w.startsWith("data: ")){const b=w.slice(6).trim();if(b==="[DONE]")continue;try{const f=(g=(p=JSON.parse(b).choices[0])==null?void 0:p.delta)==null?void 0:g.content;f&&(a+=f,n(f))}catch{}}}return{content:a}}isConfigured(){var t;return!(!this.model||!this.baseUrl||this.settings.provider!=="ollama"&&!((t=this.settings.apiKey)!=null&&t.trim()))}async testConnection(){var e;try{const t={"Content-Type":"application/json"};(e=this.settings.apiKey)!=null&&e.trim()&&(t.Authorization=`Bearer ${this.settings.apiKey.trim()}`);const s=k(this.settings.extraHeaders);return Object.assign(t,s),(await u(`${this.baseUrl}/chat/completions`,{method:"POST",headers:t,body:JSON.stringify({model:this.model,messages:[{role:"user",content:"Hi"}],max_tokens:5})})).ok}catch{return!1}}}export{A as OpenAICompatibleClient};
