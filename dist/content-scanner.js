const h={aasServer:[/\/shells\//i,/\/submodels\//i,/\/aas\//i,/\/api\/v\d+\/aas/i,/\/registry\//i,/\/repository\//i,/\/lookup\//i],idDomains:[/^https?:\/\/id\./i,/^https?:\/\/[^/]+\/id\//i,/digitallink/i,/gs1/i],aasxFile:[/\.aasx$/i,/\.aasx\?/i],passport:[/battery[-_]?passport/i,/digital[-_]?product[-_]?passport/i,/dpp\./i,/\/passport\//i]},g=["Product","IndividualProduct","SomeProducts","Vehicle","Car","MotorizedBicycle","OfferCatalog","ItemList","HowTo","Recipe","TechArticle","ProductModel","ProductGroup"],p=["gtin","gtin13","gtin14","gtin8","sku","mpn","serialNumber","productID","identifier","vehicleIdentificationNumber"],y=["product:gtin","product:sku","product:upc","og:product:gtin","product:retailer_item_id","product:brand"];function l(t){for(const r of Object.values(h))for(const n of r)if(n.test(t))return!0;return!1}function m(t){for(const[r,n]of Object.entries(h))for(const e of n)if(e.test(t))return r;return null}function A(){const t=[];return document.querySelectorAll('script[type="application/ld+json"]').forEach(n=>{try{const e=n.textContent;if(!e)return;const i=JSON.parse(e),s=Array.isArray(i)?i:i["@graph"]?i["@graph"]:[i];for(const o of s){const d=(Array.isArray(o["@type"])?o["@type"]:[o["@type"]]).find(a=>g.some(u=>a==null?void 0:a.includes(u)));if(d){const a=p.some(u=>o[u]!==void 0);t.push({type:"jsonld",confidence:a?"high":"medium",description:`Found ${d} with ${a?"product identifier":"no identifier"}`,data:{"@type":d,identifier:p.find(u=>o[u]!==void 0)}})}}}catch{}}),t}function S(){const t=[];return document.querySelectorAll("a[href]").forEach(n=>{const e=n.getAttribute("href");if(e&&!(e.startsWith("javascript:")||e==="#"))try{const i=new URL(e,window.location.href).href;if(l(i)){const s=m(i);let o="low",c="Link matches AAS pattern";s==="aasxFile"?(o="high",c="Link to AASX file"):s==="aasServer"?(o="high",c="Link to AAS server endpoint"):s==="passport"?(o="medium",c="Link to Digital Product Passport"):s==="idDomain"&&(o="medium",c="Link to ID domain"),t.push({type:"link",confidence:o,description:c,url:i})}}catch{}}),t}function k(){const t=[];return y.forEach(n=>{const e=document.querySelector(`meta[property="${n}"], meta[name="${n}"]`);if(e){const i=e.getAttribute("content");i&&t.push({type:"meta",confidence:"medium",description:`Found ${n} meta tag`,data:{name:n,content:i}})}}),document.querySelectorAll('link[rel="alternate"]').forEach(n=>{const e=n.getAttribute("type"),i=n.getAttribute("href");e&&i&&(e.includes("json")||e.includes("xml")||e.includes("rdf"))&&l(i)&&t.push({type:"link",confidence:"high",description:"Alternate link to machine-readable format",url:i})}),t}function L(){const t=window.location.href;return l(t)?{type:"structured",confidence:"high",description:`Page URL matches ${m(t)||"AAS"} pattern`,url:t}:null}function P(t){if(t.length===0)return"none";const r=t.some(e=>e.confidence==="high"),n=t.some(e=>e.confidence==="medium");return r?"high":n?"medium":"low"}function T(){const t=[],r=L();r&&t.push(r),t.push(...A()),t.push(...S()),t.push(...k());const n=new Set,e=t.filter(i=>i.url?n.has(i.url)?!1:(n.add(i.url),!0):!0);return{url:window.location.href,confidence:P(e),findings:e,timestamp:new Date().toISOString()}}function b(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f):f()}function f(){const t=T();chrome.runtime.sendMessage({type:"PAGE_SCAN_RESULT",result:t})}b();
