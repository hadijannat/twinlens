var k=Object.defineProperty;var v=(t,e,n)=>e in t?k(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var y=(t,e,n)=>v(t,typeof e!="symbol"?e+"":e,n);import{r as _}from"./assets/id-resolver-BQbKsSbj.js";import{M as A}from"./assets/constants-BYPtLrr_.js";const R=["/.well-known/aas","/.well-known/aas.json","/aas.json","/aas","/shell-descriptors"],U={timeout:1e4,skipWellKnown:!1,skipGS1Resolver:!1,maxRedirects:5},f="idlink_cache_",C=36e5,b=3e5;class x{constructor(e){y(this,"memoryCache",new Map);y(this,"maxEntries");y(this,"defaultTTL");this.maxEntries=(e==null?void 0:e.maxEntries)??100,this.defaultTTL=(e==null?void 0:e.defaultTTL)??C}async get(e){const n=this.normalizeKey(e),o=Date.now(),r=this.memoryCache.get(n);if(r){if(r.expiresAt>o)return r.result;this.memoryCache.delete(n)}try{const s=f+n,a=(await chrome.storage.local.get(s))[s];if(a&&a.expiresAt>o)return this.memoryCache.set(n,a),a.result;a&&await chrome.storage.local.remove(s)}catch{}return null}async set(e,n,o){const r=this.normalizeKey(e),s=o??(n.status==="failed"||n.status==="cancelled"?b:this.defaultTTL),i={result:n,expiresAt:Date.now()+s};this.memoryCache.size>=this.maxEntries&&!this.memoryCache.has(r)&&await this.evictOldest(),this.memoryCache.set(r,i);try{const a=f+r;await chrome.storage.local.set({[a]:i})}catch{}}async invalidate(e){const n=this.normalizeKey(e);this.memoryCache.delete(n);try{await chrome.storage.local.remove(f+n)}catch{}}async clear(){this.memoryCache.clear();try{const e=await chrome.storage.local.get(null),n=Object.keys(e).filter(o=>o.startsWith(f));n.length>0&&await chrome.storage.local.remove(n)}catch{}}async prune(){const e=Date.now();for(const[n,o]of this.memoryCache.entries())o.expiresAt<=e&&this.memoryCache.delete(n);try{const n=await chrome.storage.local.get(null),o=[];for(const[r,s]of Object.entries(n))r.startsWith(f)&&s.expiresAt<=e&&o.push(r);o.length>0&&await chrome.storage.local.remove(o)}catch{}}normalizeKey(e){try{const n=new URL(e);n.host=n.host.toLowerCase(),n.pathname=n.pathname.replace(/\/+$/,"")||"/";const o=new URLSearchParams(n.search),r=new URLSearchParams([...o.entries()].sort((s,i)=>s[0].localeCompare(i[0])));return n.search=r.toString(),n.toString()}catch{return e}}async evictOldest(){const e=this.memoryCache.keys().next().value;if(e){this.memoryCache.delete(e);try{await chrome.storage.local.remove(f+e)}catch{}}}}const P=["application/json","application/ld+json","application/aas+json","application/aasx","application/asset-administration-shell-package","application/zip"],O=[/\.aasx$/i,/\/shells\//i,/\/submodels\//i,/\/aas\//i,/\/api\/v\d+\/aas/i,/\/registry\//i,/\/shell-descriptors/i];function L(t,e){const n=t.toLowerCase(),o=(e==null?void 0:e.toLowerCase())??"";return n.endsWith(".aasx")||o.includes("aasx")||o.includes("asset-administration-shell-package")?"aasx":/\/shells\//i.test(t)||/\/shell-descriptors/i.test(t)?"aas-api":/\/submodels\//i.test(t)?"submodel-api":/\/registry\//i.test(t)?"registry":/passport/i.test(t)||/dpp\./i.test(t)||/digitalproduct/i.test(t)?"dpp-portal":"unknown"}function D(t){const e=[],n=t.split(",");for(const o of n){const r=o.trim().split(";");if(r.length<2)continue;const s=r[0];if(!s)continue;const i=s.match(/<([^>]+)>/);if(!i||!i[1])continue;const a=i[1],c={};for(let l=1;l<r.length;l++){const h=r[l];if(!h)continue;const u=h.trim().match(/(\w+)="?([^"]+)"?/);u&&u[1]&&u[2]&&(c[u[1].toLowerCase()]=u[2])}(c.rel==="alternate"||c.rel==="describedby")&&e.push({url:a,type:L(a,c.type),contentType:c.type,discoveryMethod:"link-header",confidence:.8})}return e}const N={name:"direct",priority:1,canHandle(){return!0},async resolve(t,e,n){const o=[],r=new AbortController,s=n.timeout??1e4;n.signal&&n.signal.addEventListener("abort",()=>r.abort());const i=setTimeout(()=>r.abort(),s);try{const a=await fetch(t,{method:"HEAD",redirect:"follow",signal:r.signal,headers:{Accept:"application/json, application/ld+json, application/aasx, */*"}});clearTimeout(i);const c=a.url,l=a.headers.get("Content-Type")??void 0;c!==t&&o.push({url:c,type:L(c,l),contentType:l,discoveryMethod:"redirect",confidence:.9});const h=O.some(d=>d.test(c)),u=l?P.some(d=>l.includes(d)):!1;(h||u)&&c===t&&o.push({url:c,type:L(c,l),contentType:l,discoveryMethod:"direct",confidence:u?.95:.7});const m=a.headers.get("Link");if(m){const d=D(m);o.push(...d)}}catch(a){if(clearTimeout(i),a instanceof Error&&a.name==="AbortError")throw a}return o}},j=["application/json","application/ld+json","application/aas+json"],M=['"assetAdministrationShells"','"submodels"','"idShort"','"semanticId"','"modelType"','"AssetAdministrationShell"'];function K(t){return t.includes("shell-descriptors")?"registry":t.includes("aas")?"aas-api":"unknown"}function G(t){return M.some(e=>t.includes(e))}const F={name:"well-known",priority:2,canHandle(t,e){return e.type==="passport"||/^https?:\/\/id\./i.test(t)},async resolve(t,e,n){if(n.skipWellKnown)return[];const o=[],r=n.timeout??1e4;let s;try{const l=new URL(t);s=`${l.protocol}//${l.host}`}catch{return[]}const i=new AbortController;n.signal&&n.signal.addEventListener("abort",()=>i.abort());const a=R.map(async l=>{const h=s+l;try{const u=setTimeout(()=>i.abort(),r),m=await fetch(h,{method:"GET",signal:i.signal,headers:{Accept:"application/json, application/ld+json, */*"}});if(clearTimeout(u),!m.ok)return null;const d=m.headers.get("Content-Type")??"";if(!j.some(I=>d.includes(I)))return null;const g=await m.text();return G(g)?{url:h,type:K(l),contentType:d,discoveryMethod:"well-known",confidence:.85}:null}catch{return null}}),c=await Promise.allSettled(a);for(const l of c)l.status==="fulfilled"&&l.value&&o.push(l.value);return o}},$=[/^https?:\/\/id\.gs1\.org\//i,/^https?:\/\/dlnkd\.tn\.gg\//i,/^https?:\/\/[^/]+\.gs1\.[^/]+\//i],B=["gs1:hasDigitalTwin","gs1:sustainabilityInfo","gs1:productDataSheet","gs1:certificationInfo","gs1:traceability","gs1:regulatoryInfo","https://gs1.org/voc/hasDigitalTwin","https://gs1.org/voc/sustainabilityInfo","https://gs1.org/voc/productDataSheet"];function Q(t){const e=t.toLowerCase();return e.includes("digitaltwin")||e.includes("digital-twin")?"aas-api":e.includes("sustainability")||e.includes("productdata")||e.includes("certification")||e.includes("regulatory")?"dpp-portal":"unknown"}function H(t){const e=[];if(!t.linkset||!Array.isArray(t.linkset))return e;for(const n of t.linkset)for(const[o,r]of Object.entries(n)){if(o==="anchor"||!B.some(a=>o===a||o.includes(a.split(":")[1]??"")))continue;const i=Array.isArray(r)?r:[r];for(const a of i){const c=a;c.href&&e.push({url:c.href,type:Q(o),contentType:c.type,discoveryMethod:"gs1-resolver",confidence:.9})}}return e}const z={name:"gs1-resolver",priority:3,canHandle(t){return $.some(e=>e.test(t))},async resolve(t,e,n){if(n.skipGS1Resolver)return[];const o=[],r=n.timeout??1e4,s=new AbortController;n.signal&&n.signal.addEventListener("abort",()=>s.abort());try{const i=new URL(t);i.searchParams.set("linkType","all");const a=setTimeout(()=>s.abort(),r),c=await fetch(i.toString(),{method:"GET",signal:s.signal,headers:{Accept:"application/linkset+json, application/json"}});if(clearTimeout(a),!c.ok||!(c.headers.get("Content-Type")??"").includes("json"))return o;const h=await c.json(),u=H(h);o.push(...u)}catch{}return o}},W=[N,F,z].sort((t,e)=>t.priority-e.priority),T=new x;function E(t){const e=new Map;for(const n of t){const o=e.get(n.url);(!o||n.confidence>o.confidence)&&e.set(n.url,n)}return Array.from(e.values())}async function q(t,e={}){var m;const n=Date.now(),o={...U,...e},r=await T.get(t);if(r)return r;const s=_(t);if(s.type==="unknown"){const d={status:"failed",originalUrl:t,parsedLink:s,endpoints:[],error:"Invalid or unrecognized URL format",duration:Date.now()-n,timestamp:new Date().toISOString()};return await T.set(t,d),d}const i=[];let a,c;for(const d of W){if((m=o.signal)!=null&&m.aborted)return{status:"cancelled",originalUrl:t,parsedLink:s,endpoints:E(i),finalUrl:a,duration:Date.now()-n,timestamp:new Date().toISOString()};if(d.canHandle(t,s))try{const p=await d.resolve(t,s,o);if(i.push(...p),d.name==="direct"&&p.length>0){const g=p.find(S=>S.discoveryMethod==="redirect");g&&(a=g.url)}}catch(p){if(p instanceof Error){if(p.name==="AbortError")return{status:"cancelled",originalUrl:t,parsedLink:s,endpoints:E(i),finalUrl:a,duration:Date.now()-n,timestamp:new Date().toISOString()};c=p.message}}}const l=E(i).sort((d,p)=>p.confidence-d.confidence),h=l.length>0?"resolved":"failed",u={status:h,originalUrl:t,parsedLink:s,endpoints:l,finalUrl:a,error:h==="failed"?c??"No endpoints discovered":void 0,duration:Date.now()-n,timestamp:new Date().toISOString()};return await T.set(t,u),u}const w=new Map;chrome.runtime.onInstalled.addListener(()=>{chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}),chrome.contextMenus.create({id:"open-in-twinlens",title:"Open in TwinLens",contexts:["link"],targetUrlPatterns:["*://*/*.aasx","*://*/*.AASX"]}),chrome.contextMenus.create({id:"scan-qr-code",title:"Scan QR Code for DPP",contexts:["image"]})});chrome.contextMenus.onClicked.addListener(async(t,e)=>{if(t.menuItemId==="open-in-twinlens"&&t.linkUrl&&(await chrome.storage.local.set({pendingAasxUrl:t.linkUrl}),e!=null&&e.id&&chrome.sidePanel.open({tabId:e.id})),t.menuItemId==="scan-qr-code"&&t.srcUrl)try{let n;try{n=new URL(t.srcUrl)}catch(a){throw console.debug("QR scan: Invalid URL:",a),new Error("Invalid URL")}if(!["https:","http:"].includes(n.protocol))throw new Error(`Invalid URL scheme: ${n.protocol}`);const o=await fetch(t.srcUrl);if(!o.ok)throw new Error(`HTTP ${o.status}`);const r=o.headers.get("Content-Length");if(r&&parseInt(r,10)>A)throw new Error("Image too large (max 5MB)");const s=await o.blob();if(s.size>A)throw new Error("Image too large (max 5MB)");const i=await new Promise((a,c)=>{const l=new FileReader;l.onloadend=()=>a(l.result),l.onerror=()=>c(new Error("Failed to read image")),l.readAsDataURL(s)});await chrome.storage.local.set({pendingQRImage:{dataUrl:i,srcUrl:t.srcUrl}}),e!=null&&e.id&&chrome.sidePanel.open({tabId:e.id})}catch(n){console.error("Failed to fetch QR image:",n),await chrome.storage.local.set({pendingQRImage:{error:"Failed to load image",srcUrl:t.srcUrl}}),e!=null&&e.id&&chrome.sidePanel.open({tabId:e.id})}});const V={high:"#22c55e",medium:"#f59e0b",low:"#6b7280",none:""},X={high:"âœ“",medium:"?",low:".",none:""};chrome.runtime.onMessage.addListener((t,e,n)=>{var o;if(t.type==="GET_PENDING_URL")return chrome.storage.local.get("pendingAasxUrl",r=>{n({url:r.pendingAasxUrl}),chrome.storage.local.remove("pendingAasxUrl")}),!0;if(t.type==="GET_PENDING_QR")return chrome.storage.local.get("pendingQRImage",r=>{n(r.pendingQRImage??null),chrome.storage.local.remove("pendingQRImage")}),!0;if(t.type==="PAGE_SCAN_RESULT"&&((o=e.tab)!=null&&o.id)){const{result:r}=t,s=e.tab.id,i=r.confidence,a=V[i],c=X[i];return c?(chrome.action.setBadgeText({tabId:s,text:c}),chrome.action.setBadgeBackgroundColor({tabId:s,color:a})):chrome.action.setBadgeText({tabId:s,text:""}),chrome.storage.local.set({[`scanResult_${s}`]:r}),n({received:!0}),!1}if(t.type==="GET_SCAN_RESULT"){const r=t.tabId;return chrome.storage.local.get(`scanResult_${r}`,s=>{n(s[`scanResult_${r}`]??null)}),!0}if(t.type==="RESOLVE_ID_LINK"){const{url:r,options:s,requestId:i}=t,a=new AbortController;return w.set(i,a),q(r,{...s,signal:a.signal}).then(c=>{n({type:"RESOLVE_ID_LINK_RESULT",requestId:i,result:c})}).catch(c=>{const l={type:"RESOLVE_ID_LINK_RESULT",requestId:i,error:c instanceof Error?c.message:"Resolution failed"};n(l)}).finally(()=>{w.delete(i)}),!0}if(t.type==="CANCEL_RESOLUTION"){const{requestId:r}=t,s=w.get(r);return s&&(s.abort(),w.delete(r)),n({cancelled:!0}),!1}});chrome.tabs.onRemoved.addListener(async t=>{try{await chrome.storage.local.remove(`scanResult_${t}`)}catch(e){console.warn("Failed to cleanup scan result for tab:",t,e)}});async function Y(){try{const t=await chrome.storage.local.get(null),e=Object.keys(t).filter(s=>s.startsWith("scanResult_"));if(e.length===0)return;const n=await chrome.tabs.query({}),o=new Set(n.map(s=>String(s.id))),r=e.filter(s=>{const i=s.replace("scanResult_","");return!o.has(i)});r.length>0&&(await chrome.storage.local.remove(r),console.log(`Cleaned up ${r.length} orphaned scan result(s)`))}catch(t){console.warn("Failed to cleanup orphaned results:",t)}}chrome.runtime.onInstalled.addListener(()=>{Y()});
