var I=Object.defineProperty;var E=(t,e,n)=>e in t?I(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var f=(t,e,n)=>E(t,typeof e!="symbol"?e+"":e,n);var c=(t=>(t.NAMEPLATE="nameplate",t.CARBON_FOOTPRINT="carbon_footprint",t.TECHNICAL_DATA="technical_data",t.HANDOVER_DOCUMENTATION="handover_documentation",t.GENERIC="generic",t))(c||{});function P(t,e="en"){var s;if(!t||t.length===0)return;const n=t.find(o=>o.language===e);return n?n.text:(s=t[0])==null?void 0:s.text}const C={"https://admin-shell.io/zvei/nameplate":c.NAMEPLATE,"https://admin-shell.io/idta/CarbonFootprint":c.CARBON_FOOTPRINT,"https://admin-shell.io/ZVEI/TechnicalData":c.TECHNICAL_DATA,"https://admin-shell.io/vdi/2770/1/0/Documentation":c.HANDOVER_DOCUMENTATION};function T(t){var e,n,s;return(s=(n=(e=t.semanticId)==null?void 0:e.keys)==null?void 0:n[0])==null?void 0:s.value}function v(t){const e=T(t);if(!e)return c.GENERIC;for(const[n,s]of Object.entries(C))if(e.startsWith(n))return s;return c.GENERIC}const w={general:"twinlens_general_settings",compliance:"twinlens_compliance_settings"},O={scanIntensity:"passive",localOnlyMode:!1,theme:"system",compactMode:!1,validationMode:"lenient"},N={enabledRulePacks:["eu-battery-regulation"],severityOverride:"default",showFutureRules:!0};async function b(t,e){var n;try{if(typeof chrome<"u"&&((n=chrome==null?void 0:chrome.storage)!=null&&n.sync)){const s=await chrome.storage.sync.get(t);if(s[t])return{...e,...s[t]}}}catch(s){console.warn(`Failed to load ${t}:`,s)}return e}async function V(t,e){var n;try{typeof chrome<"u"&&((n=chrome==null?void 0:chrome.storage)!=null&&n.sync)&&await chrome.storage.sync.set({[t]:e})}catch(s){console.warn(`Failed to save ${t}:`,s)}}async function k(){return b(w.general,O)}async function q(){return b(w.compliance,N)}class m extends Error{constructor(e){super(`Network blocked: ${e}`),this.name="NetworkBlockedError"}}async function _(){return(await k()).localOnlyMode}async function D(t,e,n={}){if(!n.bypassLocalOnly&&await _())throw new m("Local-only mode is enabled. Disable it in Options to make network requests.");const s=n.allowedSchemes??["https:","http:"];let o;try{o=new URL(t)}catch{throw new m(`Invalid URL: ${t}`)}if(!s.includes(o.protocol))throw new m(`Scheme '${o.protocol}' not allowed`);return fetch(t,e)}function A(t){try{const e=new URL(t);return`${e.protocol}//${e.host}/*`}catch{return t}}async function R(t){if(typeof chrome>"u"||!chrome.permissions)return!0;try{const e=A(t);return await chrome.permissions.contains({origins:[e]})}catch{return!1}}async function x(t){if(typeof chrome>"u"||!chrome.permissions)return!0;try{const e=A(t);return await chrome.permissions.contains({origins:[e]})?!0:await chrome.permissions.request({origins:[e]})}catch(e){return console.warn("Permission request failed:",e),!1}}async function S(t,e,n){if(!await R(t)&&!await x(t))throw new Error(`Permission denied for ${new URL(t).origin}. Please grant access in the extension popup.`);return D(t,e,n)}function M(t,e){const n={};switch(e){case c.NAMEPLATE:$(t,n);break;case c.CARBON_FOOTPRINT:L(t,n);break;case c.TECHNICAL_DATA:W(t,n);break;case c.HANDOVER_DOCUMENTATION:F(t,n);break;default:H(t,n)}return{keyProperties:n}}function h(t){if(t.modelType==="Property")return t.value;if(t.modelType==="MultiLanguageProperty")return P(t.value)}function $(t,e){const n=["ManufacturerName","ManufacturerProductDesignation","SerialNumber","YearOfConstruction","DateOfManufacture","ProductCountryOfOrigin"];for(const s of t.submodelElements||[])if(n.includes(s.idShort||"")){const o=h(s);o&&(e[s.idShort]=o)}}function L(t,e){var n,s,o,r;for(const a of t.submodelElements||[])if(a.modelType==="SubmodelElementCollection"){const i=a;if((n=a.idShort)!=null&&n.includes("CarbonFootprint")||(s=a.idShort)!=null&&s.includes("PCF")){for(const u of i.value||[])if((o=u.idShort)!=null&&o.includes("CO2")||(r=u.idShort)!=null&&r.includes("Carbon")){const l=h(u);l&&(e[u.idShort]=l)}}}}function W(t,e){for(const n of t.submodelElements||[])if(n.modelType==="SubmodelElementCollection"&&n.idShort==="GeneralInformation"){const s=n;for(const o of s.value||[]){const r=h(o);r&&(e[o.idShort||"unknown"]=r)}}}function F(t,e){let n=0;for(const s of t.submodelElements||[])s.modelType==="SubmodelElementCollection"&&n++;e.DocumentCount=String(n)}function H(t,e,n=10){let s=0;for(const o of t.submodelElements||[]){if(s>=n)break;const r=h(o);r&&o.idShort&&(e[o.idShort]=r,s++)}}function J(t){const e=t.assetAdministrationShells[0],n=e==null?void 0:e.assetInformation,s=(t.submodels||[]).map(a=>U(a)),o=JSON.stringify(s),r=Math.ceil(o.length/4);return{assetId:(n==null?void 0:n.globalAssetId)||"unknown",assetIdShort:e==null?void 0:e.idShort,assetKind:n==null?void 0:n.assetKind,shellId:(e==null?void 0:e.id)||"unknown",shellIdShort:e==null?void 0:e.idShort,submodelSummaries:s,estimatedTokens:r}}function U(t){var o,r,a;const e=v(t),{keyProperties:n,fullContent:s}=M(t,e);return{id:t.id||"unknown",idShort:t.idShort||"unknown",semanticId:(a=(r=(o=t.semanticId)==null?void 0:o.keys)==null?void 0:r[0])==null?void 0:a.value,templateType:e!==c.GENERIC?e:void 0,keyProperties:n,fullContent:s}}function G(t){const e=["## Asset Information",`- Asset ID: ${t.assetId}`];t.assetIdShort&&e.push(`- Asset Name: ${t.assetIdShort}`),t.assetKind&&e.push(`- Asset Kind: ${t.assetKind}`),t.shellIdShort&&e.push(`- Shell Name: ${t.shellIdShort}`),e.push("","## Submodels");for(const n of t.submodelSummaries){e.push("",`### ${n.idShort}`),n.templateType&&e.push(`Type: ${n.templateType}`),n.semanticId&&e.push(`Semantic ID: ${n.semanticId}`),e.push("Properties:");for(const[s,o]of Object.entries(n.keyProperties))e.push(`- ${s}: ${o}`)}return e.join(`
`)}function j(t){return`You are an AI assistant helping users understand a Digital Product Passport (DPP) based on the Asset Administration Shell (AAS) standard.

## Your Role
- Answer questions about the loaded asset based on the provided data
- Explain technical specifications, compliance information, and documentation
- Help users understand the structure and content of the AAS
- Provide accurate, grounded responses citing specific data when possible

## Response Guidelines
1. **Be accurate**: Only state facts present in the data. If information isn't available, say so.
2. **Cite sources**: When referencing specific values, mention the submodel and property name.
3. **Be concise**: Provide direct answers, then elaborate if needed.
4. **Use context**: Reference the asset by its name/ID when appropriate.
5. **Explain terminology**: Help users understand AAS concepts when relevant.

## Asset Data

${G(t)}

## Important Notes
- This data comes from an AAS environment file (AASX or JSON)
- Semantic IDs reference standard definitions (IRDI, IRI)
- Document references point to files within the AASX package`}function Y(t){const e=[],n=t.assetIdShort||"this product",s=new Map,o=new Set;for(const r of t.submodelSummaries){r.templateType&&o.add(r.templateType);for(const[a,i]of Object.entries(r.keyProperties))s.set(a.toLowerCase(),i)}if(e.push(`What can you tell me about ${n}?`),o.has("nameplate")&&(s.has("serialnumber")?e.push("What is the serial number and manufacturing date?"):e.push("Who manufactured this and where was it made?")),o.has("carbon_footprint")&&([...s.keys()].some(a=>a.includes("co2")||a.includes("carbon"))?e.push("How does the carbon footprint break down by lifecycle phase?"):e.push("What is the environmental impact of this product?")),o.has("technical_data")&&e.push("What are the key technical specifications?"),o.has("handover_documentation")){const r=s.get("documentcount");r&&parseInt(r,10)>0?e.push(`What are the ${r} available documents about?`):e.push("What documentation is available?")}return e.length<4&&([...s.keys()].some(i=>i.includes("warranty")||i.includes("maintenance"))&&e.push("What are the warranty and maintenance requirements?"),[...s.keys()].some(i=>i.includes("certification")||i.includes("marking")||i.includes("compliance"))&&e.push("What certifications does this product have?")),e.length<4&&e.push("Is this product compliant with relevant regulations?"),[...new Set(e)].slice(0,4)}class B{constructor(e){f(this,"settings");f(this,"baseUrl","https://api.anthropic.com/v1");this.settings=e}isConfigured(){return!!this.settings.apiKey}async testConnection(){if(!this.isConfigured())return!1;try{return(await S(`${this.baseUrl}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({model:this.settings.model||"claude-sonnet-4-20250514",max_tokens:10,messages:[{role:"user",content:"Hi"}]})})).ok}catch{return!1}}async chat(e,n,s){var u;if(!this.isConfigured())throw new Error("Anthropic API key not configured");const o=j(n),r=this.convertMessages(e),a=await S(`${this.baseUrl}/messages`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({model:this.settings.model||"claude-sonnet-4-20250514",max_tokens:this.settings.maxTokens||1024,system:o,messages:r,stream:!!s})});if(!a.ok){const l=await a.text();throw new Error(`Anthropic API error: ${l}`)}if(s&&a.body)return this.handleStream(a.body,s);const i=await a.json();return{content:((u=i.content[0])==null?void 0:u.text)||"",usage:i.usage?{inputTokens:i.usage.input_tokens,outputTokens:i.usage.output_tokens}:void 0}}getHeaders(){return{"Content-Type":"application/json","x-api-key":this.settings.apiKey||"","anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"}}convertMessages(e){return e.filter(n=>n.role!=="system").map(n=>({role:n.role,content:n.content}))}async handleStream(e,n){var i;const s=e.getReader(),o=new TextDecoder;let r="",a="";try{for(;;){const{done:u,value:l}=await s.read();if(u)break;a+=o.decode(l,{stream:!0});const p=a.split(`
`);a=p.pop()||"";for(const y of p)if(y.startsWith("data: ")){const g=y.slice(6);if(g==="[DONE]")continue;try{const d=JSON.parse(g);d.type==="content_block_delta"&&((i=d.delta)!=null&&i.text)&&(r+=d.delta.text,n(d.delta.text))}catch{}}}}finally{s.releaseLock()}return{content:r}}}const z=Object.freeze(Object.defineProperty({__proto__:null,AnthropicClient:B},Symbol.toStringTag,{value:"Module"}));export{N as D,w as S,c as T,S as a,Y as b,J as c,v as d,O as e,G as f,P as g,q as h,b as i,z as j,k as l,V as s};
